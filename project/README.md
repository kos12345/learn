## геораспределённый кластер.  
2 сервера находятся в датацентре A1  
2 сервера находятся в датацентре А2  
1 сервер находится в датацентре А3  
1 сервер для бэкапов и отстающей реплики в датацентре А1 (опционально его можно разместить где угодно)  
установка необходимых пакетов (без описания какие репо подключал.)  
yum install postgresql15 postgresql15-contrib postgresql15-libs postgresql15-server pg_probackup-15 haproxy keepalived consul patroni-consul-3.0.4  

**1. сервис consul**  
основой работы кластера является DCS. для создания DCS мы используем сервис consul.  
приложен конфиг config.json.  
сервис разворачивается на всех серверах (кроме сервера бэкапов) и позволит при аварии одного из датацентров собрать кворум из оставшегося большинства.  

**2. сервис keepalived**  
в датацентрах А1 и А2 на всех серверах развернут сервис keepalived для поддержания двух виртуальных ip адресов.  
в каждом датацентре свой VIP.  
приложен конфиг keepalived.conf и баш-скрипт для определения где находится мастер patroni_check.sh  
в разных ДЦ указываются свои VIP 10.10.1.3 или 10.10.2.3  

**3. сервис haproxy**  
в датацентрах А1 и А2 на всех серверах развернут сервис haproxy для перенаправления запросов к серверу мастеру postgresql.  
при нормальной работе сервера приложений подключаются к vip адресу в своём датацентре и попадают сразу на мастер postgresql.  
при аварии может возникнуть такая ситуация что мастер переедет в другой датацентр и тогда haproxy выручит в этой ситуации.  
приложен конфиг haproxy.cfg  
для rw подключений поднят порт 5555, который всегда ведёт на мастер, для ro подключений поднят порт 5556, который ведёт на любую реплику кроме синхронной, для снижения нагрузки.  

**4. сервис patroni**  
в датацентрах А1 и А2 на всех серверах развернут сервис patroni  
приложен конфиг patroni.yml. на разных серверах в конфиге меняется ip адрес и имя сервера.  

**5. сервер для бэкапов**  
на всех серверах установлен pg_probackup.   
прописан сервер для бэкапов wal-логов выделенный сервер 10.10.1.4. бэкап снимается с сервера 10.10.1.2  
все команды настройки представленны в файле pg_probackup.txt  

**6. на этом же сервере развернута отстающая реплика.**  
отставание 1 день.  
репликация настроена через wal-архив, чтобы запросы на этой реплике никоим образом не оказывали влияния на основной кластер postgresql.  
приложен файл настройки реплики recovery.txt

